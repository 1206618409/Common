						MySQL 索引

索引存在哪？ 

​	索引存放在磁盘中

两个原理 ：1、局部性原理 

​								空间局部性

​								时间局部性

​					2、磁盘预读  预读的长度一般为页（page）的整数倍      （页的大小通常为4K）

索引是帮助MySQL 高效获取数据的数据结构

索引存储在文件系统中

索引的文件存储形式与存储引擎有关

索引文件的结构  ：hash、 二叉树、B树、B+树

<img src="F:\资料\javase\java-master\database\note\索引\mysql数据结构选择.png" alt="1574247344026" style="zoom:100%;" />



```
hash：
	哈希表可以完成索引的存储，每次在添加索引的时候需要计算指定列的hash值，取模运算最后计算出下标，将元素插入下标位置即可
   适合场景：
   表中的数据是无序（范围查找的时候比较浪费时间，需要挨个进行遍历操作）
查询  大部分 范围查询  不是特别适合
hash表在使用的时候，需要将全部的数据加载到内存，比较耗费内存的空间，也不是很合适
```

二叉树

```
二叉树及其N多的变种都不能支撑索引，原因是树的深度无法控制或者插入的数据的性能比较低
```

B树  

<img src="F:\资料\javase\java-master\database\note\索引\mysql索引系统.png" alt="1574247344026" style="zoom:100%;" />

```

B +Tree是在BTree的基础之上做的一种优化，变化如下:
1、B+Tree每个节点可以包含更多的节点,这个做的原因有两个，第一个原因是为了 降低树的高度，第二个原因是将数据范围变为多个区间，区间越多，数据检索越快
2、非叶子节点存储key，叶子节点存储key和数据
3、叶子节点两两指针相互连接(符合磁盘的预读特性)， 顺序查询性能更高

```



 注意:在B+Tree上有两个头指针，一个指向根节点 ，另一个指向关键字最小的叶子节点，而且所有叶子节点(即数据节点)之间是种链式环结构。因此可以对B+ Tree进行两种查找运算: -种是对于主键的范围查找和分页查找另种是从根节 点开始，进行随机查找。 

------------------------------------------------------------------------------------------------------------------------------------------------------

```
 mysqlInnoDB--B+Tree,叶子节 点直接放置数据
```

 注意:
1 InnoDB是通过B + Tree结构对主键创建索引，然后叶子节点中存储记录，如果没有主键，那么会选择唯一键如果没有唯一键，那么会生成一个6位的row id来作为主键
2、如果创建索引的键是其他字段,那么在叶子节点中存储的是该记录的主键，然后再通过主键索引找到对应的记录叫做回表

索引分类  ：

​	主键索引   	主键是一种唯一性索引，但它必须指定为PRIMARY KEY，每个表只能有一个主键

​	唯一索引   索引列的所有值都只能出现一次，即必须唯一，值可以为空       不需要回表

​	普通索引    基本的索引类型，值可以为空，没有唯一性的限制         需要回表（有可能出现覆盖索引问题存在）

​	全文索引    ：	MyISAM支持，Innodb在5.6之后支持（一般不会用到，公司在做搜索引擎，一般使用es、         		solr、Lucene）目前Lucene不用了，solr在老牌公司用，更多选择es 

​				全文索引的索引类型为FULLTEXT。全文索引可以在varchar、char、text类型的列上创建

​	组合索引          多列值组成个索引，专门用于组合搜索（最左匹配原则）

|          | 是否回表 | 是否覆盖 |
| :------: | :------: | :------: |
| 主键索引 | 没有回表 |  不覆盖  |
| 唯一索引 | 没有回表 |  不覆盖  |
| 普通索引 |   回表   |   覆盖   |



![1574304082523](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1574304082523.png)



​		索引维护

```sql

▪ 索引在插入新的值的时候，为了维护索引的有序性，必须要维护，
在维护索引的时候需要需要分以下集中情况：
– 1、如果插入一个比较大的值，直接插入即可，几乎没有成本
– 2、如果插入的是中间的某一个值，需要逻辑上移动后续的元素，空出位置
– 3、如果需要插入的数据页满了，就需要单独申请一个新的数据页，然后移
动部分数据过去，叫做页分裂，此时性能会受影响同时空间的使用率也会降
低，除了页分裂之外还包含页合并
▪ 尽量使用自增主键作为索引

```

连接器
▪ 连接器负责跟客户端建立连接，获取权限、维持和管理连接
– 用户名密码验证
– 查询权限信息，分配对应的权限
– 可以使用show processlist查看现在的连接
– 如果太长时间没有动静，就会自动断开，通过wait_timeout控制，默认8小时
▪ 连接可以分为两类：
– 长连接：推荐使用，但是要周期性的断开长连接
– 短链接：



查询缓存 （默认不开启  8.0没了）
▪ 当执行查询语句的时候，会先去查询缓存中查看结果，之前执行
过的sql语句及其结果可能以key-value的形式存储在缓存中，如
果能找到则直接返回，如果找不到，就继续执行后续的阶段。
▪ 但是，不推荐使用查询缓存：
– 1、查询缓存的失效比较频繁，只要表更新，缓存就会清空
– 2、缓存对应新更新的数据命中率比较低

查看查询缓存情况：
show variables like '%query_cache%'; 
（query_cache_type 为 ON 表示已经开启）

优化器
▪ 在具体执行SQL语句之前，要先经过优化器的处理
– 当表中有多个索引的时候，决定用哪个索引
– 当sql语句需要做多表关联的时候，决定表的连接顺序
– 等等
▪ 不同的执行方式对SQL语句的执行效率影响很大
– RBO:基于规则的优化
– CBO:基于成本的优化



Mysql日志系统  



![1574315001466](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1574315001466.png)

![1574314872104](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1574314872104.png)



![1574314899541](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1574314899541.png)



![1574316001898](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1574316001898.png)

发生数据修改的时候，innodb会先卸载redo log中，并更新内存，此时更新完成，redo日志是固定大小的，是循环写的过程

事务中就是通过redo log进行书写的

▪ 



![1574316015329](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1574316015329.png)



binlog 

Binlog中会记录所有的逻辑，并且采用追加写的方式 

般在企业中数据库会有备份系统，可以定期执行备份，备份的 

周期可以自己设置 

恢复数据的过程： 

1、找到最近次的全量备份数据 

2、从备份的时间点开始，将备份的binlog取出来，重放到要恢复的那个时刻

![1574316576508](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1574316576508.png)

![1574316733039](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1574316733039.png)

